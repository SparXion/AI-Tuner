<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>AI Tuner v3.0 - Customize AI Response Style</title>
    <link rel="stylesheet" href="style.css?v=3.0.2">
    <link rel="stylesheet" href="style-v3.0.css?v=3.0.2">
    <style>
        /* Force dark mode colors - loaded last to override everything */
        body.dark-mode .radar-container-box,
        body.dark-mode .radar-container-box h3,
        body.dark-mode .radar-container-box * {
            color: #ffffff !important;
        }
        
        body.dark-mode .prompt-container-box,
        body.dark-mode .prompt-container-box h3,
        body.dark-mode .prompt-container-box * {
            color: #ffffff !important;
        }
        
        body.dark-mode .step-number {
            background: #ffffff !important;
            color: #000000 !important;
            border-color: #ffffff !important;
        }
        
        /* Exceptions for buttons inside containers */
        body.dark-mode .radar-container-box .btn,
        body.dark-mode .prompt-container-box .btn {
            color: #ffffff !important;
        }
        
        body.dark-mode .radar-container-box .btn-primary,
        body.dark-mode .prompt-container-box .btn-primary {
            background: #ffffff !important;
            color: #000000 !important;
        }
    </style>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <div style="display: flex; justify-content: flex-end; align-items: center; gap: 10px; margin-bottom: 20px;">
                <div style="display: flex; gap: 10px;">
                    <button id="emoji-shutoff-toggle" class="btn btn-secondary" style="font-size: 1rem; padding: 8px 16px;">
                        <span id="emoji-shutoff-text">No Emojis</span>
                    </button>
                    <button id="dark-mode-toggle" class="btn btn-secondary" style="font-size: 1rem; padding: 8px 16px;">
                        <span id="dark-mode-text">Dark Mode</span>
                    </button>
                </div>
            </div>
            <h1>AI Tuner v3.0</h1>
            <p class="subtitle" id="mode-subtitle">Customize AI behavior with precision controls</p>
            <div class="mode-toggle-container" style="margin-top: 20px;">
                <div class="mode-toggle-boxes">
                    <button id="mode-beginner" class="mode-box" data-mode="beginner">
                        <span>Beginner</span>
                    </button>
                    <button id="mode-advanced" class="mode-box" data-mode="advanced">
                        <span>Advanced</span>
                    </button>
                </div>
            </div>
            <div class="mode-description">
                <strong>Beginner:</strong> 12 essential levers | <strong>Advanced:</strong> All 26 tuning levers
            </div>
            
            <!-- Expandable Info Section -->
            <div class="app-info-section" style="margin-top: 30px;">
                <button id="app-info-toggle" class="app-info-toggle">
                    <span class="app-info-toggle-text">What is AI Tuner?</span>
                    <span class="app-info-toggle-icon">‚ñº</span>
                </button>
                <div id="app-info-content" class="app-info-content">
                    <div class="app-info-inner">
                        <h3>About AI Tuner</h3>
                        <p><strong>AI Tuner</strong> lets you customize how AI assistants respond to you. Instead of accepting default behavior, you can fine-tune personality, tone, and communication style.</p>
                        
                        <h4>How It Works</h4>
                        <ol class="app-info-steps">
                            <li><strong>Choose Your AI Model</strong> - Select from 7 leading platforms (Grok, Gemini, Claude, ChatGPT, Perplexity, Mistral, Llama). Each has its own default personality.</li>
                            <li><strong>Apply Hidden Mode</strong> - Override the default with specialized personas like Therapist, Truth-Seeker, or Coder modes.</li>
                            <li><strong>Fine-Tune Settings</strong> - Adjust 12-26 sliders to control specific behaviors like empathy, conciseness, creativity, and more.</li>
                        </ol>
                        
                        <h4>Key Features</h4>
                        <ul class="app-info-features">
                            <li><strong>Universal Tuning:</strong> Works with any AI model through prompt engineering</li>
                            <li><strong>26 Precise Levers:</strong> Control everything from hedging intensity to answer completeness</li>
                            <li><strong>Live Preview:</strong> See your settings visualized in a radar chart and generated prompt</li>
                            <li><strong>Save Presets:</strong> Create and reuse your favorite configurations</li>
                            <li><strong>Beginner/Advanced Modes:</strong> Start simple with 12 essential levers or unlock all 26 for complete control</li>
                        </ul>
                        
                        <p><em>Copy the generated prompt and paste it into your AI chat to apply your custom tuning.</em></p>
                    </div>
                </div>
            </div>
            
            <!-- Saved Presets Section -->
            <div class="saved-presets-header" style="margin-top: 30px;">
                <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 10px;">Saved Presets</h3>
                <div id="saved-presets-container" class="preset-buttons-header">
                    <p class="no-presets-message" style="color: #999; font-style: italic; margin: 0; font-size: 0.9rem;">No saved presets yet. Create one using "Save Preset" button.</p>
                </div>
            </div>
        </header>

        <!-- Personality & Approach Selector - Above Live Preview -->
        <div class="personality-selector-section" style="margin: 30px 0; padding: 20px; border: 2px solid #000; border-radius: 4px; background: #fff;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                <h2 style="margin: 0; font-size: 1.3rem; font-weight: 500;">Personality & Approach</h2>
                <span class="info-btn-step" data-step="personality" style="cursor: pointer; width: 20px; height: 20px; border-radius: 50%; border: 1px solid #000; display: inline-flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 600; background: #000; color: #fff;">‚Ñπ</span>
            </div>
            <label for="personality-select" style="display: block; margin-bottom: 8px; font-weight: 500; color: #666;">Intellectual Style</label>
            <select id="personality-select" class="personality-select">
                <option value="neutral">Neutral - Objective, balanced</option>
                <option value="socratic">Socratic - Question-driven, probing</option>
                <option value="curious">Curious - Inquisitive, exploratory</option>
                <option value="analytical">Analytical - Methodical, systematic</option>
                <option value="sarcastic">Sarcastic - Sharp, ironic</option>
                <option value="witty">Witty - Clever, humorous</option>
                <option value="charming">Charming - Engaging, charismatic</option>
                <option value="sympathetic">Sympathetic - Understanding, supportive</option>
                <option value="empathetic">Empathetic - Emotionally attuned</option>
                <option value="directive">Directive - Authoritative, commanding</option>
                <option value="collaborative">Collaborative - Cooperative, inclusive</option>
                <option value="provocative">Provocative - Challenging, thought-provoking</option>
            </select>
        </div>

        <main class="main-layout">
            <!-- Preview Section (Left Side) -->
            <div class="preview-section-container">
                <div class="preview-section">
                    <!-- Radar Container Box -->
                    <div class="radar-container-box">
                        <h3>Live Preview</h3>
                        <div class="radar-wrapper">
                            <canvas id="radarCanvas"></canvas>
                        </div>
                    </div>
                    
                    <!-- Prompt Container Box -->
                    <div class="prompt-container-box">
                        <h3>Generated Prompt</h3>
                        
                        <!-- Saved Presets Section - Mobile only (hidden on desktop) -->
                        <div class="saved-presets-header saved-presets-mobile" style="display: none; margin-bottom: 20px;">
                            <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 10px;">Saved Presets</h3>
                            <div id="saved-presets-container-mobile" class="preset-buttons-header">
                                <p class="no-presets-message" style="color: #999; font-style: italic; margin: 0; font-size: 0.9rem;">No saved presets yet. Create one using "Save Preset" button.</p>
                            </div>
                        </div>
                        
                        <div class="prompt-preview" id="prompt-preview">
                            <p class="placeholder-text">‚Üê Start by selecting a model (Step 1)</p>
                        </div>
                        <div class="actions">
                            <button id="copy-prompt" class="btn btn-primary">Copy Prompt</button>
                            <button id="save-preset" class="btn btn-secondary">Save Preset</button>
                            <button id="download-json" class="btn btn-secondary">Download Config</button>
                            <button id="download-markdown" class="btn btn-secondary">Download Doc</button>
                            <button id="upload-config" class="btn btn-secondary">Upload Config</button>
                        </div>
                        <input type="file" id="file-input" accept=".json" style="display: none;">
                    </div>
                </div>
            </div>

            <!-- Three-Step Workflow (Right Side) -->
            <div class="workflow-container">
                <!-- Step 1: Choose Model (Trunk) -->
                <div class="workflow-step step-1">
                    <div class="step-header">
                        <div class="step-number">1</div>
                        <div class="step-title">
                            <h2>Choose Your AI Model <span class="info-btn-step" data-step="1">‚Ñπ</span></h2>
                            <p class="step-description">Select the AI platform you want to tune. This sets the foundation with the model's default persona.</p>
                        </div>
                    </div>
                    <div class="model-grid" id="model-selector">
                        <!-- Models will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Step 2: Apply Hidden Mode (Branch 1) -->
                <div class="workflow-step step-2">
                    <div class="step-header">
                        <div class="step-number">2</div>
                        <div class="step-title">
                            <h2>Apply Hidden Mode <span class="info-btn-step" data-step="2">‚Ñπ</span></h2>
                            <p class="step-description">Apply a specialized persona from the secret menu. These override the default model persona.</p>
                        </div>
                    </div>
                    <div class="persona-grid" id="persona-selector">
                        <!-- Personas will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Step 3: Fine-Tune (Branch 2) -->
                <div class="workflow-step step-3">
                    <div class="step-header">
                        <div class="step-number">3</div>
                        <div class="step-title">
                            <h2>Fine-Tune Your Settings <span class="info-btn-step" data-step="3">‚Ñπ</span></h2>
                            <p class="step-description">Adjust sliders to customize the AI's behavior precisely.</p>
                        </div>
                    </div>
                    <div class="controls-section" id="controls-section">
                        <!-- Levers will be populated by JavaScript organized by 12 categories -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Info Popup Overlay -->
    <div id="info-overlay" class="info-overlay">
        <div class="info-popup">
            <div class="info-header">
                <h3 id="info-title">Lever Information</h3>
                <button id="info-close" class="info-close">√ó</button>
            </div>
            <div class="info-content" id="info-content">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- Chart.js with fallback for mobile -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js" 
            onerror="this.onerror=null; loadChartJSFallback();"></script>
    <script>
        // Fallback if CDN fails (common on mobile)
        function loadChartJSFallback() {
            console.warn('Chart.js CDN failed, trying alternative CDN...');
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/chart.js@latest/dist/chart.umd.js';
            script.onerror = function() {
                console.error('All Chart.js CDNs failed');
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; background: #ff0000; color: #fff; padding: 15px; z-index: 10000; text-align: center; font-size: 14px;';
                errorDiv.innerHTML = '‚ö†Ô∏è Chart.js failed to load. The radar chart may not work, but the rest of the app should function. <button onclick="location.reload()" style="margin-left: 10px; padding: 5px 10px; background: #fff; color: #000; border: none; cursor: pointer;">Reload</button>';
                document.body.appendChild(errorDiv);
            };
            script.onload = function() {
                console.log('Chart.js loaded from fallback CDN');
            };
            document.head.appendChild(script);
        }
    </script>
    <script src="js/data/v3.0-models.js?v=3.0.2"></script>
    <script src="js/data/v3.0-levers.js?v=3.0.2"></script>
    <script src="js/data/v3.0-personas.js?v=3.0.2"></script>
    <script src="radar.js?v=3.0.2"></script>
    <script src="js/core/v3.0-engine.js?v=3.0.2"></script>
    <script>
        // Force cache refresh on mobile if needed
        (function() {
            const version = '3.0.2';
            const storedVersion = localStorage.getItem('aituner-version');
            if (storedVersion !== version) {
                console.log('üîÑ Version changed, clearing cache...');
                localStorage.setItem('aituner-version', version);
                // Force reload if version changed
                if (storedVersion && storedVersion !== version) {
                    window.location.reload(true);
                }
            }
        })();
        
        // SIMPLIFIED: No DOM manipulation - let CSS handle mobile layout
        // The radar chart stays in its original position, CSS handles reordering on mobile
        
        // Error handling and loading state
        window.addEventListener('error', function(e) {
            // Ignore Chart.js resize errors that we're handling
            if (e.message && (
                e.message.includes('ownerDocument') ||
                e.message.includes('Chart.js') ||
                e.filename && e.filename.includes('chart.js')
            )) {
                // These are handled by our resize handler, just log a warning
                console.warn('Chart.js resize error (handled):', e.message);
                return;
            }
            
            console.error('JavaScript Error:', e.message, e.filename, e.lineno);
            // Only show critical errors to user
            if (!e.message || (!e.message.includes('ownerDocument') && !e.message.includes('Chart.js'))) {
                // Show error message to user for non-Chart.js errors
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; background: #ff0000; color: #fff; padding: 10px; z-index: 10000; text-align: center;';
                errorDiv.textContent = 'Error loading page. Check console for details.';
                document.body.appendChild(errorDiv);
            }
        });
        
        // Check if scripts loaded (for debugging)
        window.addEventListener('load', function() {
            console.log('‚úÖ Page fully loaded');
            console.log('Chart.js available:', typeof Chart !== 'undefined');
            console.log('AITunerV6 available:', typeof window.AITunerV6 !== 'undefined');
            console.log('LEVERS_V6 available:', typeof window.LEVERS_V6 !== 'undefined');
            console.log('MODELS_V6 available:', typeof window.MODELS_V6 !== 'undefined');
            console.log('PERSONAS_V6 available:', typeof window.PERSONAS_V6 !== 'undefined');
            
            // Mobile-specific: Check if we're on mobile
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;
            if (isMobile) {
                console.log('üì± Mobile device detected');
            }
        });
        
        // Initialize v3.0 app
        // Load dark mode preference BEFORE DOMContentLoaded to prevent flash
        (function() {
            const savedDarkMode = localStorage.getItem('aiTunerDarkMode') === 'true';
            if (savedDarkMode) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
        })();
        
        // Wait for all scripts to load, especially on mobile
        let isInitializing = false;
        let isInitialized = false;
        
        function initializeApp() {
            // Prevent multiple initializations
            if (isInitializing || isInitialized) {
                console.log('App already initializing or initialized, skipping...');
                return;
            }
            
            isInitializing = true;
            console.log('Initializing app...');
            console.log('Chart.js available:', typeof Chart !== 'undefined');
            console.log('AITunerV6 available:', typeof window.AITunerV6 !== 'undefined');
            console.log('LEVERS_V6 available:', typeof window.LEVERS_V6 !== 'undefined');
            console.log('MODELS_V6 available:', typeof window.MODELS_V6 !== 'undefined');
            console.log('PERSONAS_V6 available:', typeof window.PERSONAS_V6 !== 'undefined');
            
            // Check critical dependencies
            if (typeof window.AITunerV6 === 'undefined') {
                isInitializing = false;
                console.error('AITunerV6 not loaded!');
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; background: #ff0000; color: #fff; padding: 15px; z-index: 10000; text-align: center; font-size: 14px;';
                errorDiv.innerHTML = '‚ùå Application script failed to load. <button onclick="location.reload()" style="margin-left: 10px; padding: 5px 10px; background: #fff; color: #000; border: none; cursor: pointer; border-radius: 4px;">Reload Page</button>';
                document.body.appendChild(errorDiv);
                return;
            }
            
            // Chart.js is optional - app can work without it
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js not loaded - radar chart will not work, but app will continue');
                // Don't block initialization, just warn
            }
            
            try {
                window.aiTuner = new window.AITunerV6();
                console.log('‚úÖ AI Tuner initialized successfully');
                isInitialized = true;
                
                // Hide loader if still visible
                const loader = document.getElementById('page-loader');
                if (loader) {
                    loader.style.opacity = '0';
                    loader.style.transition = 'opacity 0.3s';
                    setTimeout(() => loader.remove(), 300);
                }
            } catch (error) {
                console.error('Error initializing AI Tuner:', error);
                isInitializing = false;
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; background: #ff0000; color: #fff; padding: 15px; z-index: 10000; text-align: center; font-size: 14px;';
                errorDiv.innerHTML = '‚ùå Error: ' + (error.message || 'Unknown error') + ' <button onclick="location.reload()" style="margin-left: 10px; padding: 5px 10px; background: #fff; color: #000; border: none; cursor: pointer; border-radius: 4px;">Reload</button>';
                document.body.appendChild(errorDiv);
            } finally {
                isInitializing = false;
            }
        }
        
        // Try to initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener("DOMContentLoaded", () => {
                // Give scripts a moment to load, especially on mobile
                setTimeout(initializeApp, 100);
            });
        } else {
            // DOM already loaded
            setTimeout(initializeApp, 100);
        }
        
        // Also try on window load as backup
        window.addEventListener('load', () => {
            // If app hasn't initialized yet, try again
            if (!window.aiTuner && !isInitialized && !isInitializing) {
                setTimeout(initializeApp, 200);
            }
        });
        
        // Add loading indicator
        (function() {
            const loader = document.createElement('div');
            loader.id = 'page-loader';
            loader.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #fff; z-index: 9999; display: flex; align-items: center; justify-content: center; font-size: 18px;';
            loader.textContent = 'Loading AI Tuner...';
            document.body.appendChild(loader);
            
            window.addEventListener('load', function() {
                setTimeout(function() {
                    const loaderEl = document.getElementById('page-loader');
                    if (loaderEl) {
                        loaderEl.style.opacity = '0';
                        loaderEl.style.transition = 'opacity 0.3s';
                        setTimeout(function() {
                            loaderEl.remove();
                        }, 300);
                    }
                }, 500);
            });
        })();
    </script>
</body>
</html>